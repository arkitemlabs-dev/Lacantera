-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- DEBUG LOGIN - Verificar datos exactos para login
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

USE PP;
GO

PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT '๐ DEBUG LOGIN - admin@lacantera.com';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT '';

DECLARE @Email VARCHAR(100) = 'admin@lacantera.com';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 1. BUSCAR EXACTAMENTE COMO LO HACE EL CรDIGO
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PRINT '๐ QUERY EXACTA DEL CรDIGO:';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';

SELECT
    UsuarioWeb,
    Nombre,
    eMail,
    Contrasena,
    Rol,
    Estatus,
    Empresa,
    Proveedor,
    Cliente
FROM WebUsuario
WHERE eMail = @Email AND Estatus = 'ACTIVO';

PRINT '';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT '๐ VERIFICACIONES ADICIONALES';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT '';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 2. VERIFICAR ESPACIOS O CARACTERES EXTRAรOS EN EMAIL
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PRINT '๐ง Verificar email (con espacios visibles):';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';

SELECT
    UsuarioWeb,
    CONCAT('[', eMail, ']') as [Email Con Corchetes],
    LEN(eMail) as [Longitud],
    LEN(LTRIM(RTRIM(eMail))) as [Long Sin Espacios],
    CASE
        WHEN LEN(eMail) = LEN(LTRIM(RTRIM(eMail))) THEN 'โ Sin espacios'
        ELSE 'โ Tiene espacios extra'
    END as [Validaciรณn]
FROM WebUsuario
WHERE eMail LIKE '%admin%lacantera%';

PRINT '';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 3. VERIFICAR ESTATUS (exacto)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PRINT '๐ Verificar Estatus (exacto):';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';

SELECT
    UsuarioWeb,
    CONCAT('[', Estatus, ']') as [Estatus Con Corchetes],
    LEN(Estatus) as [Longitud],
    CASE
        WHEN Estatus = 'ACTIVO' THEN 'โ Coincide exacto'
        ELSE 'โ No coincide'
    END as [Validaciรณn]
FROM WebUsuario
WHERE eMail LIKE '%admin%lacantera%';

PRINT '';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 4. VERIFICAR HASH DE CONTRASEรA
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PRINT '๐ Verificar Hash de Contraseรฑa:';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';

DECLARE @HashEsperado VARCHAR(255) = '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhkO';
DECLARE @HashActual VARCHAR(255);

SELECT @HashActual = Contrasena FROM WebUsuario WHERE eMail LIKE '%admin%lacantera%';

SELECT
    UsuarioWeb,
    SUBSTRING(Contrasena, 1, 20) + '...' as [Hash Inicio],
    LEN(Contrasena) as [Longitud Hash],
    CASE
        WHEN Contrasena = @HashEsperado THEN 'โ Hash correcto'
        ELSE 'โ Hash incorrecto'
    END as [Validaciรณn Hash],
    CASE
        WHEN LEN(Contrasena) >= 60 THEN 'โ Longitud OK'
        ELSE 'โ Hash muy corto'
    END as [Validaciรณn Longitud]
FROM WebUsuario
WHERE eMail LIKE '%admin%lacantera%';

PRINT '';

-- Mostrar hashes completos para comparaciรณn
PRINT 'Hash esperado (admin123456):';
PRINT @HashEsperado;
PRINT '';
PRINT 'Hash actual en BD:';
PRINT @HashActual;
PRINT '';

IF @HashActual = @HashEsperado
    PRINT 'โ Los hashes coinciden EXACTAMENTE';
ELSE
    PRINT 'โ Los hashes NO coinciden';

PRINT '';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 5. PROBAR CON DIFERENTES VARIACIONES DEL EMAIL
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PRINT '๐ง Probar con diferentes variaciones:';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';

-- Exacto
IF EXISTS (SELECT 1 FROM WebUsuario WHERE eMail = 'admin@lacantera.com' AND Estatus = 'ACTIVO')
    PRINT 'โ Encontrado con: admin@lacantera.com';
ELSE
    PRINT 'โ NO encontrado con: admin@lacantera.com';

-- Con TRIM
IF EXISTS (SELECT 1 FROM WebUsuario WHERE LTRIM(RTRIM(eMail)) = 'admin@lacantera.com' AND Estatus = 'ACTIVO')
    PRINT 'โ Encontrado con TRIM: admin@lacantera.com';
ELSE
    PRINT 'โ NO encontrado con TRIM: admin@lacantera.com';

-- Case insensitive
IF EXISTS (SELECT 1 FROM WebUsuario WHERE LOWER(eMail) = 'admin@lacantera.com' AND Estatus = 'ACTIVO')
    PRINT 'โ Encontrado case-insensitive: admin@lacantera.com';
ELSE
    PRINT 'โ NO encontrado case-insensitive: admin@lacantera.com';

PRINT '';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 6. LISTAR TODOS LOS USUARIOS EN WebUsuario
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PRINT '๐ TODOS los usuarios en WebUsuario:';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';

SELECT
    UsuarioWeb,
    Nombre,
    CONCAT('[', eMail, ']') as Email,
    Rol,
    CONCAT('[', Estatus, ']') as Estatus,
    FORMAT(Alta, 'dd/MM/yyyy HH:mm', 'es-MX') as FechaAlta
FROM WebUsuario
ORDER BY Alta DESC;

PRINT '';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT 'โ DEBUG COMPLETADO';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
